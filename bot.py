import os
import asyncio
import sys
from telegram import Bot, InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo

# –Ø–≤–Ω–æ –ø–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
BOT_TOKEN = os.getenv("8318221511:AAFkBP4pnqGGV7ovEHfT1yIgVHvi4yK-2Fg", "").strip()
CHAT_ID = os.getenv("-1001874164448", "").strip()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
print("=" * 60)
print("üîç –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø RAILWAY")
print("=" * 60)

# –í—ã–≤–æ–¥–∏–º –í–°–ï –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–∫—Ä—ã–≤–∞—è –∑–Ω–∞—á–µ–Ω–∏—è)
all_vars = dict(os.environ)
print(f"–ù–∞–π–¥–µ–Ω–æ {len(all_vars)} –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
for key in sorted(all_vars.keys()):
    value = all_vars[key]
    masked_value = value[:3] + "***" + value[-3:] if len(value) > 6 else "***"
    print(f"  {key}: {masked_value}")

print("\n" + "=" * 60)
print("üìã –¶–ï–õ–ï–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï:")
print(f"  BOT_TOKEN: {'–£–°–¢–ê–ù–û–í–õ–ï–ù' if BOT_TOKEN else '–ù–ï –ù–ê–ô–î–ï–ù'}")
print(f"  CHAT_ID: {'–£–°–¢–ê–ù–û–í–õ–ï–ù' if CHAT_ID else '–ù–ï –ù–ê–ô–î–ï–ù'}")

if not BOT_TOKEN:
    print("\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("üëâ –î–µ–π—Å—Ç–≤–∏—è:")
    print("1. –í Railway ‚Üí Variables ‚Üí Add Variable")
    print("2. –ò–º—è: BOT_TOKEN")
    print("3. –ó–Ω–∞—á–µ–Ω–∏–µ: —Ç–æ–∫–µ–Ω –æ—Ç @BotFather")
    print("4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π")
    
    # –ñ–¥–µ–º, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
    sys.exit(1)

if not CHAT_ID:
    print("\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: CHAT_ID –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π CHAT_ID")
    # –ú–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±

async def send_price_message():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–π—Å–æ–º"""
    print("\n" + "=" * 60)
    print("üöÄ –ù–ê–ß–ò–ù–ê–Æ –û–¢–ü–†–ê–í–ö–£ –°–û–û–ë–©–ï–ù–ò–Ø")
    print("=" * 60)
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
        print(f"üì° –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ Telegram API...")
        bot = Bot(token=BOT_TOKEN)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        me = await bot.get_me()
        print(f"‚úÖ –ë–æ—Ç: @{me.username} (ID: {me.id})")
        
        # –ï—Å–ª–∏ CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—ã
        if not CHAT_ID:
            print("üîç –ò—â—É –≥—Ä—É–ø–ø—ã, –≥–¥–µ –±–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä...")
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø
            print("‚ùå CHAT_ID –Ω–µ —É–∫–∞–∑–∞–Ω. –£–∫–∞–∂–∏—Ç–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É
        print(f"üîç –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É {CHAT_ID}...")
        chat = await bot.get_chat(chat_id=CHAT_ID)
        print(f"‚úÖ –ß–∞—Ç –Ω–∞–π–¥–µ–Ω: {chat.title}")
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π
        keyboard = InlineKeyboardMarkup([[
            InlineKeyboardButton(
                text="üìä –û–¢–ö–†–´–¢–¨ –ü–†–ê–ô–°-–¢–ï–†–ú–ò–ù–ê–õ",
                web_app=WebAppInfo(url="https://price2026-production.up.railway.app")
            )
        ]])
        
        # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        message_text = """üîΩ *–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –ø—Ä–∞–π—Å—É*

_–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ_"""
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        print("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ...")
        message = await bot.send_message(
            chat_id=CHAT_ID,
            text=message_text,
            parse_mode='Markdown',
            reply_markup=keyboard,
            disable_notification=True
        )
        print(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (ID: {message.message_id})")
        
        # –ó–∞–∫—Ä–µ–ø–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        print("üìç –ó–∞–∫—Ä–µ–ø–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ...")
        await bot.pin_chat_message(
            chat_id=CHAT_ID,
            message_id=message.message_id,
            disable_notification=True
        )
        
        print("\n" + "=" * 60)
        print("üéâ –£–°–ü–ï–•! –°–û–û–ë–©–ï–ù–ò–ï –ó–ê–ö–†–ï–ü–õ–ï–ù–û!")
        print("=" * 60)
        print(f"üë• –ì—Ä—É–ø–ø–∞: {chat.title}")
        print(f"üîó –ö–Ω–æ–ø–∫–∞ –≤–µ–¥–µ—Ç –Ω–∞: https://price2026-production.up.railway.app")
        print("=" * 60)
        
        # –ñ–¥–µ–º 10 –º–∏–Ω—É—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
        print("\n‚è≥ –ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç...")
        await asyncio.sleep(600)
        
    except Exception as e:
        print(f"\n‚ùå –û–®–ò–ë–ö–ê: {type(e).__name__}: {e}")
        
        # –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        if "Forbidden" in str(e):
            print("\nüîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ë–æ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã")
            print("   –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        elif "chat not found" in str(e).lower():
            print("\nüîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π CHAT_ID –∏–ª–∏ –±–æ—Ç –Ω–µ –≤ –≥—Ä—É–ø–ø–µ")
            print(f"   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CHAT_ID: {CHAT_ID}")
        elif "Unauthorized" in str(e):
            print("\nüîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π BOT_TOKEN")
            print("   –†–µ—à–µ–Ω–∏–µ: –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —É @BotFather")
        
        # –ñ–¥–µ–º 5 –º–∏–Ω—É—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—à–∏–±–∫–∏
        await asyncio.sleep(300)

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    await send_price_message()

if __name__ == "__main__":
    print("\nü§ñ –ë–û–¢ –î–õ–Ø –ó–ê–ö–†–ï–ü–õ–ï–ù–ò–Ø –ü–†–ê–ô–°–ê")
    print("–í–µ—Ä—Å–∏—è: 2.0")
    print("=" * 60)
    
    asyncio.run(main())
    
    print("\nüèÅ –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
